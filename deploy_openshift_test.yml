---
- name: Desplegar una aplicación en OpenShift
  hosts: all
  gather_facts: no
  tasks:
    - name: Descargar el cliente oc desde la fuente oficial
      get_url:
        url: https://mirror.openshift.com/pub/openshift-v4/clients/oc/latest/linux/oc.tar.gz
        dest: /tmp/oc.tar.gz
      when: not ("oc" in ansible_play_hosts_all)
      become_user: root
    
    - name: Actualizar el archivo de hosts
      lineinfile:
        path: /etc/hosts  # Ruta al archivo de hosts en tu sistema
        line: "{{ item.ip }} {{ item.host }}"
        state: present
      with_items:
        - { ip: '52.177.22.54', host: 'console-openshift-console.apps.stracongroupdemo.local' }
        - { ip: '52.177.22.54', host: 'oauth-openshift.apps.stracongroupdemo.local' }
        - { ip: '52.177.22.54', host: 'alertmanager-main-openshift-monitoring.apps.stracongroupdemo.local' }
        - { ip: '52.177.22.54', host: 'boutique-route-boutique.apps.stracongroupdemo.local' }
        - { ip: '40.70.30.118', host: 'api.stracongroupdemo.local' }
      become_user: root


    - name: Extraer el cliente oc
      ansible.builtin.unarchive:
        src: /tmp/oc.tar.gz
        dest: /usr/local/bin
        remote_src: yes
        creates: /usr/local/bin/oc
      become: yes
      when: not ("oc" in ansible_play_hosts_all)
      become_user: root

    - name: Autenticarse en el clúster de OpenShift
      command: oc login -u kubeadmin -p vqit5-uVq55-KM5XD-qs7hJ https://api.stracongroupdemo.local:6443 --insecure-skip-tls-verify
      ignore_errors: yes
      register: oc_login
      environment:
        KUBECONFIG: /path/to/your/kubeconfig/file
      become_user: root

    - name: Crear o seleccionar el proyecto (namespace)
      command: oc new-project project-test-ansible
      when: "oc_login.rc == 0"
      environment:
        KUBECONFIG: /path/to/your/kubeconfig/file
      become_user: root